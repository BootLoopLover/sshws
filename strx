#!/bin/sh
# Simple SSHWS installer by @stdstrx
# Luci-ed by @Raducksijaa

echo "======================================="
echo " Welcome to Simple SSHWS Installer "
echo " Lucied by @Raducksijaa"
echo " Tested by Paka"
echo "======================================="

echo "[1/5] Downloading SSHWS files..."
wget -O /usr/bin/sshws https://github.com/BootLoopLover/sshws/refs/heads/sshws/usr/bin/sshws >/dev/null 2>&1
wget -O /etc/init.d/run https://raw.githubusercontent.com/BootLoopLover/sshws/refs/heads/sshws/run >/dev/null 2>&1
wget -O /usr/lib/lua/luci/controller/sshws.lua https://raw.githubusercontent.com/BootLoopLover/sshws/refs/heads/sshws/sshws.lua >/dev/null 2>&1
wget -O /usr/lib/lua/luci/view/sshws.htm https://raw.githubusercontent.com/BootLoopLover/sshws/refs/heads/sshws/sshws.htm >/dev/null 2>&1
wget -O /usr/bin/wanip https://raw.githubusercontent.com/BootLoopLover/sshws/refs/heads/sshws/wanip >/dev/null 2>&1

echo "[2/5] Setting up permissions..."
chmod +x /etc/init.d/run /usr/bin/sshws /usr/bin/wanip

echo "[3/5] Enabling SSHWS service..."
/etc/init.d/run enable
/etc/init.d/run start

echo "[4/5] Installing SSHWS watchdog..."
cat > /bin/sshwsmon <<'EOF'
#!/bin/sh -e
# SSHWS Connection Watchdog

URL="http://ifconfig.io"
INTERVAL=10
FAIL_LIMIT=5
fail_count=0

log() {
    logger -t sshws-watchdog "$@"
}

is_ipv4() {
    echo "$1" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$'
}

while true; do
    IP="$(curl -4sS --max-time 30 --connect-timeout 30 "$URL" 2>/dev/null | tr -d '\r\n')"
    if [ -n "$IP" ] && is_ipv4 "$IP"; then
        [ "$fail_count" -gt 0 ] && log "Internet OK: $IP (failure streak reset from $fail_count)"
        fail_count=0
    else
        fail_count=$((fail_count + 1))
        if [ "$fail_count" -lt "$FAIL_LIMIT" ]; then
            log "No public IP (streak $fail_count/$FAIL_LIMIT); waiting..."
        else
            log "No public IP (streak $fail_count/$FAIL_LIMIT); restarting SSHWS"
            [ -x /usr/bin/wanip ] && /usr/bin/wanip || log "wanip missing"
            /etc/init.d/run restart || log "restart failed"
            fail_count=0
        fi
    fi
    sleep "$INTERVAL"
done
EOF
chmod +x /bin/sshwsmon

echo "[5/5] Configuring interface & firewall..."
uci set network.sshws='interface'
uci set network.sshws.proto='none'
uci set network.sshws.ifname='tun0'
uci commit network >/dev/null 2>&1

uci set firewall.VPN=zone
uci set firewall.VPN.name='VPN'
uci set firewall.VPN.network='sshws'
uci set firewall.VPN.input='REJECT'
uci set firewall.VPN.forward='REJECT'
uci set firewall.VPN.output='ACCEPT'
uci set firewall.VPN.masq='1'
uci set firewall.VPN.mtu_fix='1'
uci add firewall forwarding
uci set firewall.@forwarding[-1].src='lan'
uci set firewall.@forwarding[-1].dest='VPN'
uci commit firewall >/dev/null 2>&1
/etc/init.d/firewall reload >/dev/null 2>&1

echo "✅ Installation complete — Welcome to SSHWS World!"
rm -f "$0"
